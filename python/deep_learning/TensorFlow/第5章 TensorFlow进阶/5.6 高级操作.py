import os

import keras.datasets.imdb
import tensorflow as tf
import numpy as np

os.environ['TF_CPP_MIN_LOG_LEVEL'] = "1"

if __name__ == '__main__':
    # ### 5.6 é«˜çº§æ“ä½œ
    #
    # #### 5.6.1 tf.gather
    #
    # - tf.gather å¯ä»¥å®ç°æ ¹æ®ç´¢å¼•å·æ”¶é›†æ•°æ®çš„ç›®çš„
    # - tf.gather éå¸¸é€‚åˆç´¢å¼•å·æ²¡æœ‰è§„åˆ™çš„åœºåˆï¼Œå…¶ä¸­ç´¢å¼•å·å¯ä»¥ä¹±åºæ’åˆ—ï¼Œæ­¤æ—¶æ”¶ é›†çš„æ•°æ®ä¹Ÿæ˜¯å¯¹åº”é¡ºåº
    # Gather slices from params axis axis according to indices. indices must be an integer tensor of any dimension (often 1-D).
    # Tensor.getitem works for scalars, tf.newaxis, and python slices
    # tf.gather extends indexing to handle tensors of indices.
    # In the simplest case it's identical to scalar indexing:
    # è€ƒè™‘ç­çº§æˆç»©å†Œçš„ä¾‹å­ï¼Œ
    # å‡è®¾å…±æœ‰ 4ä¸ªç­çº§ï¼Œæ¯ä¸ªç­çº§ 35 ä¸ªå­¦ç”Ÿï¼Œ8 é—¨ç§‘ç›®ï¼Œ
    # ä¿å­˜æˆç»©å†Œçš„å¼ é‡ shape ä¸º[4,35,8]ã€‚
    # x = tf.random.uniform([4, 35, 8], maxval=100, dtype=tf.int32)
    # # (4, 35, 8)
    # print(x.shape)
    # # ç°åœ¨éœ€è¦æ”¶é›†ç¬¬ 1~2 ä¸ªç­çº§çš„æˆç»©å†Œï¼Œå¯ä»¥ç»™å®šéœ€è¦æ”¶é›†ç­çº§çš„ç´¢å¼•å·ï¼š[0,1]ï¼Œå¹¶æŒ‡å®šç­
    # # çº§çš„ç»´åº¦ axis=0ï¼Œé€šè¿‡ tf.gather å‡½æ•°æ”¶é›†æ•°æ®ï¼Œä»£ç å¦‚ä¸‹
    # # (2, 35, 8)
    # print(tf.gather(x, [0, 1], axis=0).shape)
    # # éœ€è¦æŠ½æŸ¥æ‰€æœ‰ç­çº§çš„ç¬¬ 1ã€4ã€9ã€12ã€13ã€27 å·åŒå­¦çš„æˆç»©æ•°æ®
    # # (4, 6, 8)
    # print(tf.gather(x, [0, 3, 8, 11, 12, 26], axis=1).shape)
    # # å¦‚æœéœ€è¦æ”¶é›†æ‰€æœ‰åŒå­¦çš„ç¬¬ 3 å’Œç¬¬ 5 é—¨ç§‘ç›®çš„æˆç»©ï¼Œåˆ™å¯ä»¥æŒ‡å®šç§‘ç›®ç»´åº¦ axis=2
    # # (4, 35, 2)
    # print(tf.gather(x, [2, 4], axis=2).shape)
    # # å¦‚æœå¸Œæœ›æŠ½æŸ¥ç¬¬[2,3]ç­çº§çš„ç¬¬[3,4,6,27]å·åŒå­¦çš„ç§‘ç›®æˆç»©ï¼Œ
    # # åˆ™å¯ä»¥é€šè¿‡ç»„åˆå¤šä¸ª tf.gather å®ç°ã€‚
    # # é¦–å…ˆæŠ½å‡ºç¬¬[2,3]ç­çº§
    # xx = tf.gather(x, [1, 2], axis=0)
    # # (2, 4, 8)
    # print(tf.gather(xx, [2, 3, 5, 26], axis=1).shape)
    # # è¿™æ¬¡æˆ‘ä»¬å¸Œæœ›æŠ½æŸ¥ç¬¬ 2 ä¸ªç­çº§çš„ç¬¬ 2 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œ
    # # ç¬¬ 3 ä¸ªç­çº§çš„ç¬¬ 3 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œç¬¬ 4 ä¸ªç­çº§çš„ç¬¬ 4 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®
    # a = tf.gather(tf.gather(x, [1], axis=0), [1], axis=1)
    # b = tf.gather(tf.gather(x, [2], axis=0), [2], axis=1)
    # c = tf.gather(tf.gather(x, [3], axis=0), [3], axis=1)
    # # [1,1,8]
    # print(a.shape)
    # print(b.shape)
    # print(c.shape)
    # # tf.stack(tensors, axis)
    # d = tf.stack([x[1, 1], x[2, 2], x[3, 3]], axis=0)
    # # [[86 49 20 41 28 98 67 14]
    # #  [16 78 96  9  4 65 51 87]
    # #  [98 30 79 76 66 88 14 66]]
    # print(d.numpy())
    #

    # #### 5.6.2 tf.gather_nd
    # tf.gather_ndçš„å‡½æ•°åŸå‹æ˜¯ï¼š
    # def gather_nd(params, indices, name=None)
    # æ ¹æ®å®šä¹‰ï¼Œ å…¶ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®indicesæè¿°çš„ç´¢å¼•ï¼Œæå–paramsä¸Šçš„å…ƒç´ ï¼Œ é‡æ–°æ„å»ºä¸€ä¸ªtensor
    # `N` dimensions of `params`, where `N = indices.shape[-1]`.

    # æˆ‘ä»¬å¸Œæœ›æŠ½æŸ¥ç¬¬ 2 ä¸ªç­çº§çš„ç¬¬ 2 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œ
    # ç¬¬ 3 ä¸ªç­çº§çš„ç¬¬ 3 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œ
    # ç¬¬ 4 ä¸ªç­çº§çš„ç¬¬ 4 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®
    # x = tf.random.uniform([4, 35, 8], maxval=100, dtype=tf.int32)
    # # (3, 8)
    # print(tf.gather_nd(x, [[1, 1], [2, 2], [3, 3]]).shape)
    #
    # # ä¸€èˆ¬åœ°ï¼Œåœ¨ä½¿ç”¨ tf.gather_nd é‡‡æ ·å¤šä¸ªæ ·æœ¬æ—¶ï¼Œ
    # # ä¾‹å¦‚å¸Œæœ›é‡‡æ ·ğ‘–å·ç­çº§ï¼Œğ‘—ä¸ªå­¦ç”Ÿï¼Œğ‘˜é—¨ç§‘ç›®çš„æˆç»©ï¼Œ
    # # åˆ™å¯ä»¥è¡¨è¾¾ä¸º[. . . , [ğ‘–, ğ‘—, ğ‘˜], . . . ]ï¼Œ
    # # å¤–å±‚çš„æ‹¬å·é•¿åº¦ä¸ºé‡‡æ ·æ ·æœ¬çš„ä¸ªæ•°ï¼Œå†…å±‚åˆ—è¡¨åŒ…å«äº†æ¯ä¸ªé‡‡æ ·ç‚¹çš„ç´¢å¼•åæ ‡
    #
    # # æˆ‘ä»¬æŠ½å‡ºäº†ç­çº§ 1 çš„å­¦ç”Ÿ 1 çš„ç§‘ç›® 2ã€ç­çº§ 2 çš„å­¦ç”Ÿ 2 çš„ç§‘ç›® 3ã€
    # # ç­çº§ 3 çš„å­¦ç”Ÿ 3 çš„ç§‘ç›® 4 çš„æˆç»©ï¼Œ
    # # å…±æœ‰ 3 ä¸ªæˆç»©æ•°æ®ï¼Œç»“æœæ±‡æ€»ä¸ºä¸€ä¸ª shape ä¸º[3]çš„å¼ é‡
    # # (3,)
    # print(tf.gather_nd(x, [[0, 0, 1], [1, 1, 2], [2, 2, 3]]).shape)

    # #### 5.6.3 tf.boolean_mask
    # tf.boolean_mask çš„ä½œç”¨æ˜¯ é€šè¿‡å¸ƒå°”å€¼ è¿‡æ»¤å…ƒç´ 
    #
    # ```python
    # def boolean_mask(tensor, mask, name="boolean_mask", axis=None):
    #     """Apply boolean mask to tensor."""
    # ```
    # é™¤äº†å¯ä»¥é€šè¿‡ç»™å®šç´¢å¼•å·çš„æ–¹å¼é‡‡æ ·ï¼Œè¿˜å¯ä»¥é€šè¿‡ç»™å®šæ©ç (Mask)çš„æ–¹å¼è¿›è¡Œé‡‡æ ·
    #
    # è¿™é‡Œçš„ tf.boolean_mask çš„ç”¨æ³•å…¶å®ä¸ tf.gather éå¸¸ç±»ä¼¼ï¼Œ
    # åªä¸è¿‡ä¸€ä¸ªé€šè¿‡æ©ç  æ–¹å¼é‡‡æ ·ï¼Œä¸€ä¸ªç›´æ¥ç»™å‡ºç´¢å¼•å·é‡‡æ ·
    #
    # å¯è§ tf.boolean_mask æ—¢å¯ä»¥å®ç°äº† tf.gather æ–¹å¼çš„ä¸€ç»´ æ©ç é‡‡æ ·ï¼Œ
    # åˆå¯ä»¥å®ç° tf.gather_nd æ–¹å¼çš„å¤šç»´æ©ç é‡‡æ ·ã€‚

    # # ä»¥ shape ä¸º[4,35,8]çš„æˆç»©å†Œå¼ é‡ä¸ºä¾‹,å³é‡‡æ ·ç¬¬ 1 å’Œç¬¬ 4 ä¸ªç­çº§çš„æ•°æ®
    # x = tf.random.uniform([4, 35, 8], maxval=100, dtype=tf.int32)
    # # (2,35,8)
    # print(tf.boolean_mask(x, [True, False, False, True], axis=0).shape)

    # ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œæˆ‘ä»¬å°†ç­çº§æ•°é‡å‡å°‘åˆ° 2 ä¸ªï¼Œ
    # å­¦ç”Ÿçš„æ•°é‡å‡å°‘åˆ° 3 ä¸ªï¼Œå³ä¸€ä¸ªç­çº§åªæœ‰ 3 ä¸ªå­¦ç”Ÿï¼Œshape ä¸º[2,3,8]ã€‚
    # å¦‚æœå¸Œæœ›é‡‡æ ·ç¬¬ 1 ä¸ªç­çº§çš„ç¬¬ 1~2 å·å­¦ç”Ÿï¼Œç¬¬ 2 ä¸ªç­çº§çš„ç¬¬ 2~3 å·å­¦ç”Ÿï¼Œ
    # é€šè¿‡tf.gather_nd å¯ä»¥å®ç°ä¸º
    # x = tf.random.uniform([2, 3, 8], maxval=100, dtype=tf.int32)
    # # gather_nd(params, indices, name=name, batch_dims=batch_dims)
    # # (4,8)
    # print(tf.gather_nd(x, [[0, 0], [0, 1], [1, 1], [1, 2]]))
    # # å¤šç»´æ©ç é‡‡æ ·
    # # ä¸¤ä¸ª[]è¯´æ˜ä»ç­çº§æ•°é‡2ä¸­å‡å–å¾—ï¼Œ[]ä¸­ä¸‰ä¸ªbooleanè¯´æ˜ä» 3 ä¸ªå­¦ç”Ÿä¸­å–
    # # (4,8)
    # print(tf.boolean_mask(x, ([True, True, False], [False, True, True])))

    # #### 5.6.4 tf.where
    # - é€šè¿‡ tf.where(cond, a, b)æ“ä½œå¯ä»¥æ ¹æ® cond æ¡ä»¶çš„çœŸå‡ä»å‚æ•°ğ‘¨æˆ–ğ‘©ä¸­è¯»å–æ•°æ®
    #
    # æ¡ä»¶åˆ¤å®šè§„åˆ™å¦‚ä¸‹ï¼š
    # ğ‘œğ‘– =
    # 1. ğ‘ğ‘– condğ‘–ä¸º True
    # 2. ğ‘ğ‘– condğ‘–ä¸º False

    #
    # å…¶ä¸­ğ‘–ä¸ºå¼ é‡çš„å…ƒç´ ç´¢å¼•ï¼Œè¿”å›çš„å¼ é‡å¤§å°ä¸ğ‘¨å’Œğ‘©ä¸€è‡´ï¼Œå½“å¯¹åº”ä½ç½®çš„condğ‘–ä¸º Trueï¼Œğ‘œğ‘–ä» ğ‘ğ‘–ä¸­å¤åˆ¶æ•°æ®ï¼›å½“å¯¹åº”ä½ç½®çš„condğ‘–ä¸º Falseï¼Œğ‘œğ‘–ä»ğ‘ğ‘–ä¸­å¤åˆ¶æ•°æ®ã€‚
    #
    # - é€šè¿‡ä¸€ç³»åˆ—çš„æ¯”è¾ƒã€ç´¢å¼•å·æ”¶é›†å’Œæ©ç æ”¶é›†çš„æ“ä½œç»„åˆæ˜¯æœ‰å¾ˆå¤§çš„å®é™…åº”ç”¨çš„

    # è€ƒè™‘ä» 2 ä¸ªå…¨ 1 å’Œå…¨ 0 çš„ 3 Ã— 3å¤§å°çš„å¼ é‡ğ‘¨å’Œğ‘©ä¸­æå–æ•°æ®ï¼Œ
    # å…¶ä¸­condğ‘–ä¸º True çš„ä½ç½®ä»ğ‘¨ä¸­å¯¹åº”ä½ç½®æå–å…ƒç´  1ï¼Œ
    # condğ‘–ä¸º False çš„ä½ç½®ä»ğ‘©å¯¹åº”ä½ç½®æå–å…ƒç´  0
    # a = tf.ones([3, 3])
    # b = tf.zeros([3, 3])
    # cond = tf.constant([[True, False, False],
    #                     [False, True, False],
    #                     [False, False, True]])
    # # [[1. 0. 0.]
    # #  [0. 1. 0.]
    # #  [0. 0. 1.]]
    # print(tf.where(cond, a, b))
    #
    # # -å½“å‚æ•° a=b=None æ—¶ï¼Œå³ a å’Œ b å‚æ•°ä¸æŒ‡å®šï¼Œtf.where ä¼šè¿”å› cond å¼ é‡ä¸­æ‰€æœ‰ True çš„å…ƒç´ çš„ç´¢å¼•åæ ‡ã€‚
    # # If `x` and `y` are not provided (both are None):
    # #   `tf.where` will return the indices of `condition` that are non-zero
    # # [[0 0]
    # #  [1 1]
    # #  [2 2]]
    # print(tf.where(cond))

    # æˆ‘ä»¬éœ€è¦æå–å¼ é‡ä¸­æ‰€æœ‰æ­£æ•°çš„æ•°æ®å’Œç´¢å¼•ã€‚
    # é¦–å…ˆæ„é€ å¼ é‡ aï¼Œå¹¶é€šè¿‡æ¯”è¾ƒè¿ç®—å¾—åˆ°æ‰€æœ‰æ­£æ•°çš„ä½ç½®æ©ç 
    # x = tf.random.normal([3, 3])
    # mask = x > 0
    # print(x)
    # print(mask)
    # indices = tf.where(mask)
    #
    # # tf.gather_nd(x, [[1, 1], [2, 2], [3, 3]]
    # # tf.boolean_mask(x, [True, False, False, True], axis=0)
    #
    # # æ‹¿åˆ°ç´¢å¼•åï¼Œé€šè¿‡ tf.gather_nd å³å¯æ¢å¤å‡ºæ‰€æœ‰æ­£æ•°çš„å…ƒç´ ï¼š
    # print(tf.gather_nd(x, indices))
    # print(tf.boolean_mask(x, mask))

    # #### 5.6.5 scatter_nd
    #
    # å¼ é‡ç™½æ¿åˆ·æ–°ï¼Œæœ‰ç›®çš„æ€§åˆ·æ–°
    #
    # é€šè¿‡ tf.scatter_nd(indices, updates, shape)å‡½æ•°å¯ä»¥é«˜æ•ˆåœ°åˆ·æ–°å¼ é‡çš„éƒ¨åˆ†æ•°æ®ï¼Œ

    # æ„é€ éœ€è¦åˆ·æ–°æ•°æ®çš„ä½ç½®å‚æ•°ï¼Œå³ä¸º 4ã€3ã€1 å’Œ 7 å·ä½ç½®
    # indices = [[4], [3], [1], [7]]
    # # æ„é€ éœ€è¦å†™å…¥çš„æ•°æ®ï¼Œ4 å·ä½å†™å…¥ 4.4,3 å·ä½å†™å…¥ 3.3ï¼Œä»¥æ­¤ç±»æ¨
    # updates = [4.4, 3.3, 1.1, 7.7]
    # # åœ¨é•¿åº¦ä¸º 8 çš„å…¨ 0 å‘é‡ä¸Šæ ¹æ® indices å†™å…¥ updates æ•°æ®
    # # [0,1.1,0,3.3,4.4,0,0,7.7]
    # print(tf.scatter_nd(indices=indices, updates=updates, shape=[8]))

    # ä½†æ˜¯è¿™ä¸ªå‡½æ•°åªèƒ½åœ¨å…¨ 0 çš„ç™½æ¿å¼ é‡ä¸Šé¢æ‰§è¡Œåˆ·æ–°æ“ä½œï¼Œ
    #
    # å› æ­¤å¯èƒ½éœ€è¦ç»“åˆå…¶å®ƒæ“ä½œæ¥å®ç°ç°æœ‰å¼ é‡çš„æ•°æ®åˆ·æ–°åŠŸèƒ½ã€‚
    #
    # ç›´æ¥ç”¨scatter_ndæ˜¯ä»å…¨0ç™½æ¿æ›´æ–°ï¼Œå¦‚ä½•ä»å·²æœ‰çš„æ•°æ®ä¸Šæ›´æ–°ï¼Ÿ
    #
    # 1. å‡è®¾Aæ˜¯å¾…æ›´æ–°ï¼Œä»Aä¸­å°†å¾…æ›´æ–°çš„éƒ¨åˆ†å€¼å–å‡ºï¼Œç”¨scatter_ndç”ŸæˆA'
    # 2. æ‹¿A=A-A'æ¸…é™¤å¾…æ›´æ–°çš„éƒ¨åˆ†å€¼ï¼ˆclearï¼‰
    # 3. æ–°çš„å€¼é€šè¿‡scatter_ndç”ŸæˆA'',åˆ™A=A+A''å¯è¿›è¡Œéƒ¨åˆ†æ›´æ–°

    # A = tf.range(8) * 2
    # indices = tf.range(1, 8, 2)
    # indices = tf.reshape(indices, shape=[4, -1])
    # print(indices)
    #
    # print(tf.reshape(tf.gather(A, indices), shape=[-1]))
    # # indices = [[1] [3] [5] [7]]
    # # tf.reshape(tf.gather(A, indices), shape=[-1]) =  [ 2  6 10 14]
    # A1 = tf.scatter_nd(indices=indices,
    #                    updates=tf.reshape(tf.gather(A, indices), shape=[-1]),
    #                    shape=[8])
    # # A1 = [ 0  2  0  6  0 10  0 14]
    # print(A1)
    # A = A - A1
    # # A = [ 0  0  4  0  8  0 12  0]
    # print(A)
    # updates = [2.2, 6.6, 10.10, 14.14]
    # A2 = tf.scatter_nd(indices=indices,
    #                    updates=updates,
    #                    shape=[8])
    # # A2 = [ 0.    2.2   0.    6.6   0.   10.1   0.   14.14]
    # print(A2)
    # A = tf.cast(A, dtype=tf.float32) + A2
    # # A = [ 0.    2.2   4.    6.6   8.   10.1  12.   14.14]
    # print(A)

    # #### 5.6.6 meshgrid
    #
    # - é€šè¿‡ tf.meshgrid å‡½æ•°å¯ä»¥æ–¹ä¾¿åœ°ç”ŸæˆäºŒç»´ç½‘æ ¼çš„é‡‡æ ·ç‚¹åæ ‡ï¼Œæ–¹ä¾¿å¯è§†åŒ–ç­‰åº”ç”¨åœºåˆã€‚
    #

    # é€šè¿‡åœ¨ x è½´ä¸Šè¿›è¡Œé‡‡æ · 100 ä¸ªæ•°æ®ç‚¹ï¼Œy è½´ä¸Šé‡‡æ · 100 ä¸ªæ•°æ®ç‚¹ï¼Œ
    # ç„¶ååˆ©ç”¨tf.meshgrid(x, y)å³å¯è¿”å›è¿™ 10000 ä¸ªæ•°æ®ç‚¹çš„å¼ é‡æ•°æ®ï¼Œ
    # ä¿å­˜åœ¨ shape ä¸º[100,100,2]çš„å¼ é‡ä¸­ã€‚
    # ä¸ºäº†æ–¹ä¾¿è®¡ç®—ï¼Œtf.meshgrid ä¼šè¿”å›åœ¨ axis=2 ç»´åº¦åˆ‡å‰²åçš„ 2 ä¸ªå¼ é‡ğ‘¨å’Œğ‘©ï¼Œ
    # å…¶ä¸­å¼ é‡ğ‘¨åŒ…å«äº†æ‰€æœ‰ç‚¹çš„ x åæ ‡ï¼Œğ‘©åŒ…å«äº†æ‰€æœ‰ç‚¹çš„ y åæ ‡ï¼Œshape éƒ½ä¸º[100,100]ï¼Œå®ç°å¦‚ä¸‹

    """
        x = [1, 2, 3]
        y = [4, 5, 6]
        X, Y = tf.meshgrid(x, y)
        # X = [[1, 2, 3],
        #      [1, 2, 3],
        #      [1, 2, 3]]
        # Y = [[4, 4, 4],
        #      [5, 5, 5],
        #      [6, 6, 6]]
    """
    x = tf.linspace(-8, 8, 100)
    y = tf.linspace(-8, 8, 100)
    X, Y = tf.meshgrid(x, y)
    # (100, 100)
    # (100, 100)
    print(X.shape)
    print(Y.shape)

    # åˆ©ç”¨ç”Ÿæˆçš„ç½‘æ ¼ç‚¹åæ ‡å¼ é‡ğ‘¨å’Œğ‘©ï¼ŒSinc å‡½æ•°åœ¨ TensorFlow ä¸­å®ç°å¦‚ä¸‹ï¼š
    # sinc å‡½æ•°å®ç°
    z = tf.sqrt(X ** 2 + Y ** 2)
    z = tf.sin(z) / z

    # é€šè¿‡ matplotlib åº“å³å¯ç»˜åˆ¶å‡ºå‡½æ•°åœ¨ğ‘¥ âˆˆ [âˆ’8,8],ğ‘¦ âˆˆ [âˆ’8,8]åŒºé—´çš„ 3D æ›²é¢
    # import matplotlib
    # from matplotlib import pyplot as plt
    # # å¯¼å…¥ 3D åæ ‡è½´æ”¯æŒ
    # from mpl_toolkits.mplot3d import Axes3D
    #
    # fig = plt.figure()
    # ax = Axes3D(fig)  # è®¾ç½® 3D åæ ‡è½´
    # # æ ¹æ®ç½‘æ ¼ç‚¹ç»˜åˆ¶ sinc å‡½æ•° 3D æ›²é¢
    # ax.contour3D(x.numpy(), y.numpy(), z.numpy(), 50)
    # plt.show()

    # - é€šè¿‡ tf.stack([x,y],axis=2) å¯ä»¥å°†xï¼Œyè¿˜åŸæˆå¯¹åº”çš„åæ ‡
    # stackçš„æ“ä½œï¼šå½“axis â‰¥ 0æ—¶ï¼Œåœ¨axis ä¹‹å‰æ’å…¥ï¼›å½“axis < 0æ—¶ï¼Œåœ¨ axis ä¹‹åæ’å…¥æ–°ç»´åº¦ã€‚
    cord = tf.stack([X, Y], axis=2)
    # cord.shape=(100, 100, 2)
    print(cord.shape)
    pass
