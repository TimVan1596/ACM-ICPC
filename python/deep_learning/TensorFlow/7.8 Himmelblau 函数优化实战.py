## 7.8 Himmelblau å‡½æ•°ä¼˜åŒ–å®æˆ˜
import tensorflow as tf
import numpy as np
import matplotlib.pyplot as plt

from matplotlib import pyplot as plt, cm


# 1. é¦–å…ˆæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹ä»£ç å®ç° Himmelblau å‡½æ•°çš„è¡¨è¾¾å¼
def Himmelblau(input):
    # himmelblau å‡½æ•°å®ç°ï¼Œä¼ å…¥å‚æ•° x ä¸º 2 ä¸ªå…ƒç´ çš„ List
    x = input[0]
    y = input[1]
    return (x**2 + y - 11) ** 2 + (x + y**2 - 7) ** 2


# Himmelblau å‡½æ•°çš„å¯è§†åŒ–æ“ä½œ
def visual_functions():
    # 2. ç„¶åå®Œæˆ Himmelblau å‡½æ•°çš„å¯è§†åŒ–æ“ä½œã€‚é€šè¿‡ np.meshgrid å‡½æ•°ç”ŸæˆäºŒç»´å¹³é¢ç½‘æ ¼ç‚¹åæ ‡
    # (TensorFlow ä¸­ä¹Ÿæœ‰meshgrid å‡½æ•°)
    x = np.arange(-10, 10, 0.1)
    y = np.arange(-10, 10, 0.1)
    print("x,y range:", x.shape, y.shape)

    # ç”Ÿæˆ x-y å¹³é¢é‡‡æ ·ç½‘æ ¼ç‚¹ï¼Œæ–¹ä¾¿å¯è§†åŒ–
    x_mesh, y_mesh = np.meshgrid(x, y)
    # print(f"X,Y maps:{x_mesh,y_mesh}")
    z_mesh = Himmelblau([x_mesh, y_mesh])

    # 3. å¹¶åˆ©ç”¨ Matplotlib åº“å¯è§†åŒ– Himmelblau å‡½æ•°
    # ç»˜åˆ¶ himmelblau å‡½æ•°æ›²é¢
    fig = plt.figure("himmelblau")
    # è®¾ç½® 3D åæ ‡è½´
    # gca = get current axes
    ax = fig.gca(projection="3d")
    # 3D æ›²é¢å›¾
    ax.plot_surface(
        x_mesh, y_mesh, z_mesh, cmap=cm.coolwarm, linewidth=0, antialiased=True
    )
    # è½¬æ¢è§†è§’è¿›è¡Œè§‚å¯Ÿï¼Œé€šè¿‡è®¾ç½®VIEW_INIT(ELEV,AZIM)ä¸¤ä¸ªå‚æ•°å˜åŒ–
    ax.view_init(45, 45)
    ax.set_xlabel("x")
    ax.set_ylabel("y")

    plt.show()


if __name__ == "__main__":
    #### 7.8 Himmelblau å‡½æ•°ä¼˜åŒ–å®æˆ˜

    """
    - Himmelblau å‡½æ•°æ˜¯ç”¨æ¥æµ‹è¯•ä¼˜åŒ–ç®—æ³•çš„å¸¸ç”¨æ ·ä¾‹å‡½æ•°ä¹‹ä¸€ï¼Œå®ƒåŒ…å«äº†ä¸¤ä¸ªè‡ªå˜é‡ğ‘¥å’Œğ‘¦
    1. é¦–å…ˆæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹ä»£ç å®ç° Himmelblau å‡½æ•°çš„è¡¨è¾¾å¼
    2. ç„¶åå®Œæˆ Himmelblau å‡½æ•°çš„å¯è§†åŒ–æ“ä½œã€‚é€šè¿‡ np.meshgrid å‡½æ•°(TensorFlow ä¸­ä¹Ÿæœ‰meshgrid å‡½æ•°)ç”ŸæˆäºŒç»´å¹³é¢ç½‘æ ¼ç‚¹åæ ‡
    3. å¹¶åˆ©ç”¨ Matplotlib åº“å¯è§†åŒ– Himmelblau å‡½æ•°
    4. Himmelblau å‡½æ•°çš„ç­‰é«˜çº¿å›¾ï¼Œå¤§è‡´å¯ä»¥çœ‹å‡ºï¼Œå®ƒå…±æœ‰ 4 ä¸ªå±€éƒ¨æå°å€¼ç‚¹ï¼Œå¹¶ä¸”å±€éƒ¨æå°å€¼éƒ½æ˜¯ 0ï¼Œæ‰€ä»¥è¿™ 4 ä¸ªå±€éƒ¨æå°å€¼ä¹Ÿæ˜¯å…¨å±€æœ€å°å€¼
    5. åˆ©ç”¨ TensorFlow è‡ªåŠ¨æ±‚å¯¼æ¥æ±‚å‡ºå‡½æ•°åœ¨ğ‘¥å’Œğ‘¦çš„åå¯¼æ•°ï¼Œå¹¶å¾ªç¯è¿­ä»£æ›´æ–°ğ‘¥å’Œğ‘¦å€¼

    å®é™…ä¸Šï¼Œé€šè¿‡æ”¹å˜ç½‘ç»œå‚æ•°çš„åˆå§‹åŒ–çŠ¶æ€ï¼Œç¨‹åºå¯ä»¥å¾—åˆ°å¤šç§æå°å€¼æ•°å€¼è§£ã€‚

    å‚æ•°çš„åˆå§‹åŒ–çŠ¶æ€æ˜¯å¯èƒ½å½±å“æ¢¯åº¦ä¸‹é™ç®—æ³•çš„æœç´¢è½¨è¿¹çš„ï¼Œç”šè‡³æœ‰å¯èƒ½æœç´¢å‡ºå®Œå…¨ä¸åŒçš„æ•°å€¼è§£
    """
    # - Himmelblau å‡½æ•°æ˜¯ç”¨æ¥æµ‹è¯•ä¼˜åŒ–ç®—æ³•çš„å¸¸ç”¨æ ·ä¾‹å‡½æ•°ä¹‹ä¸€ï¼Œå®ƒåŒ…å«äº†ä¸¤ä¸ªè‡ªå˜é‡ğ‘¥å’Œğ‘¦
    # 1. é¦–å…ˆæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹ä»£ç å®ç° Himmelblau å‡½æ•°çš„è¡¨è¾¾å¼

    # 2. ç„¶åå®Œæˆ Himmelblau å‡½æ•°çš„å¯è§†åŒ–æ“ä½œã€‚
    # visual_functions()

    # 4. Himmelblau å‡½æ•°çš„ç­‰é«˜çº¿å›¾ï¼Œå¤§è‡´å¯ä»¥çœ‹å‡ºï¼Œå®ƒå…±æœ‰ 4 ä¸ªå±€éƒ¨æå°å€¼ç‚¹ï¼Œå¹¶ä¸”å±€éƒ¨æå°å€¼éƒ½æ˜¯ 0ï¼Œæ‰€ä»¥è¿™ 4 ä¸ªå±€éƒ¨æå°å€¼ä¹Ÿæ˜¯å…¨å±€æœ€å°å€¼
    # å®ƒä»¬åˆ†åˆ«æ˜¯ï¼š
    # (3,2), (âˆ’2.805, 3.131), (âˆ’3.779, âˆ’3.283), (3.584, âˆ’1.848)

    # 5. åˆ©ç”¨ TensorFlow è‡ªåŠ¨æ±‚å¯¼æ¥æ±‚å‡ºå‡½æ•°åœ¨ğ‘¥å’Œğ‘¦çš„åå¯¼æ•°ï¼Œå¹¶å¾ªç¯è¿­ä»£æ›´æ–°ğ‘¥å’Œğ‘¦å€¼
    # å‚æ•°çš„åˆå§‹åŒ–å€¼å¯¹ä¼˜åŒ–çš„å½±å“ä¸å®¹å¿½è§†ï¼Œå¯ä»¥é€šè¿‡å°è¯•ä¸åŒçš„åˆå§‹åŒ–å€¼ï¼Œ
    # æ£€éªŒå‡½æ•°ä¼˜åŒ–çš„æå°å€¼æƒ…å†µ
    # [1., 0.], [-4, 0.], [4, 0.]
    # åˆå§‹åŒ–å‚æ•°
    x = tf.constant([-4.0, 0.0])

    for step in range(200):
        # æ¢¯åº¦è·Ÿè¸ª
        with tf.GradientTape() as tape:
            # åŠ å…¥æ¢¯åº¦è·Ÿè¸ªåˆ—è¡¨
            tape.watch([x])
            # å‰å‘ä¼ æ’­
            y = Himmelblau(x)
        # åå‘ä¼ æ’­
        grads = tape.gradient(y, [x])[0]
        # æ›´æ–°å‚æ•°
        x -= 0.01*grads
        # æ‰“å°ä¼˜åŒ–çš„æå°å€¼
        if step % 20 == 19:
            print ('step {}: x = {}, f(x) = {}'.format(step, x.numpy(), y.numpy()))
        
    pass
