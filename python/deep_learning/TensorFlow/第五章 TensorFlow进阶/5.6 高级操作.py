import os

import keras.datasets.imdb
import tensorflow as tf
import numpy as np

os.environ['TF_CPP_MIN_LOG_LEVEL'] = "1"

if __name__ == '__main__':
    # ### 5.6 é«˜çº§æ“ä½œ
    #
    # #### 5.6.1 tf.gather
    #
    # - tf.gather å¯ä»¥å®ç°æ ¹æ®ç´¢å¼•å·æ”¶é›†æ•°æ®çš„ç›®çš„
    # - tf.gather éå¸¸é€‚åˆç´¢å¼•å·æ²¡æœ‰è§„åˆ™çš„åœºåˆï¼Œå…¶ä¸­ç´¢å¼•å·å¯ä»¥ä¹±åºæ’åˆ—ï¼Œæ­¤æ—¶æ”¶ é›†çš„æ•°æ®ä¹Ÿæ˜¯å¯¹åº”é¡ºåº
    # Gather slices from params axis axis according to indices. indices must be an integer tensor of any dimension (often 1-D).
    # Tensor.getitem works for scalars, tf.newaxis, and python slices
    # tf.gather extends indexing to handle tensors of indices.
    # In the simplest case it's identical to scalar indexing:
    # è€ƒè™‘ç­çº§æˆç»©å†Œçš„ä¾‹å­ï¼Œ
    # å‡è®¾å…±æœ‰ 4ä¸ªç­çº§ï¼Œæ¯ä¸ªç­çº§ 35 ä¸ªå­¦ç”Ÿï¼Œ8 é—¨ç§‘ç›®ï¼Œ
    # ä¿å­˜æˆç»©å†Œçš„å¼ é‡ shape ä¸º[4,35,8]ã€‚
    # x = tf.random.uniform([4, 35, 8], maxval=100, dtype=tf.int32)
    # # (4, 35, 8)
    # print(x.shape)
    # # ç°åœ¨éœ€è¦æ”¶é›†ç¬¬ 1~2 ä¸ªç­çº§çš„æˆç»©å†Œï¼Œå¯ä»¥ç»™å®šéœ€è¦æ”¶é›†ç­çº§çš„ç´¢å¼•å·ï¼š[0,1]ï¼Œå¹¶æŒ‡å®šç­
    # # çº§çš„ç»´åº¦ axis=0ï¼Œé€šè¿‡ tf.gather å‡½æ•°æ”¶é›†æ•°æ®ï¼Œä»£ç å¦‚ä¸‹
    # # (2, 35, 8)
    # print(tf.gather(x, [0, 1], axis=0).shape)
    # # éœ€è¦æŠ½æŸ¥æ‰€æœ‰ç­çº§çš„ç¬¬ 1ã€4ã€9ã€12ã€13ã€27 å·åŒå­¦çš„æˆç»©æ•°æ®
    # # (4, 6, 8)
    # print(tf.gather(x, [0, 3, 8, 11, 12, 26], axis=1).shape)
    # # å¦‚æœéœ€è¦æ”¶é›†æ‰€æœ‰åŒå­¦çš„ç¬¬ 3 å’Œç¬¬ 5 é—¨ç§‘ç›®çš„æˆç»©ï¼Œåˆ™å¯ä»¥æŒ‡å®šç§‘ç›®ç»´åº¦ axis=2
    # # (4, 35, 2)
    # print(tf.gather(x, [2, 4], axis=2).shape)
    # # å¦‚æœå¸Œæœ›æŠ½æŸ¥ç¬¬[2,3]ç­çº§çš„ç¬¬[3,4,6,27]å·åŒå­¦çš„ç§‘ç›®æˆç»©ï¼Œ
    # # åˆ™å¯ä»¥é€šè¿‡ç»„åˆå¤šä¸ª tf.gather å®ç°ã€‚
    # # é¦–å…ˆæŠ½å‡ºç¬¬[2,3]ç­çº§
    # xx = tf.gather(x, [1, 2], axis=0)
    # # (2, 4, 8)
    # print(tf.gather(xx, [2, 3, 5, 26], axis=1).shape)
    # # è¿™æ¬¡æˆ‘ä»¬å¸Œæœ›æŠ½æŸ¥ç¬¬ 2 ä¸ªç­çº§çš„ç¬¬ 2 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œ
    # # ç¬¬ 3 ä¸ªç­çº§çš„ç¬¬ 3 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œç¬¬ 4 ä¸ªç­çº§çš„ç¬¬ 4 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®
    # a = tf.gather(tf.gather(x, [1], axis=0), [1], axis=1)
    # b = tf.gather(tf.gather(x, [2], axis=0), [2], axis=1)
    # c = tf.gather(tf.gather(x, [3], axis=0), [3], axis=1)
    # # [1,1,8]
    # print(a.shape)
    # print(b.shape)
    # print(c.shape)
    # # tf.stack(tensors, axis)
    # d = tf.stack([x[1, 1], x[2, 2], x[3, 3]], axis=0)
    # # [[86 49 20 41 28 98 67 14]
    # #  [16 78 96  9  4 65 51 87]
    # #  [98 30 79 76 66 88 14 66]]
    # print(d.numpy())
    #

    # #### 5.6.2 tf.gather_nd
    # tf.gather_ndçš„å‡½æ•°åŸå‹æ˜¯ï¼š
    # def gather_nd(params, indices, name=None)
    # æ ¹æ®å®šä¹‰ï¼Œ å…¶ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®indicesæè¿°çš„ç´¢å¼•ï¼Œæå–paramsä¸Šçš„å…ƒç´ ï¼Œ é‡æ–°æ„å»ºä¸€ä¸ªtensor
    # `N` dimensions of `params`, where `N = indices.shape[-1]`.

    # æˆ‘ä»¬å¸Œæœ›æŠ½æŸ¥ç¬¬ 2 ä¸ªç­çº§çš„ç¬¬ 2 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œ
    # ç¬¬ 3 ä¸ªç­çº§çš„ç¬¬ 3 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®ï¼Œ
    # ç¬¬ 4 ä¸ªç­çº§çš„ç¬¬ 4 ä¸ªåŒå­¦çš„æ‰€æœ‰ç§‘ç›®
    x = tf.random.uniform([4, 35, 8], maxval=100, dtype=tf.int32)
    # (3, 8)
    print(tf.gather_nd(x, [[1, 1], [2, 2], [3, 3]]).shape)

    # ä¸€èˆ¬åœ°ï¼Œåœ¨ä½¿ç”¨ tf.gather_nd é‡‡æ ·å¤šä¸ªæ ·æœ¬æ—¶ï¼Œ
    # ä¾‹å¦‚å¸Œæœ›é‡‡æ ·ğ‘–å·ç­çº§ï¼Œğ‘—ä¸ªå­¦ç”Ÿï¼Œğ‘˜é—¨ç§‘ç›®çš„æˆç»©ï¼Œ
    # åˆ™å¯ä»¥è¡¨è¾¾ä¸º[. . . , [ğ‘–, ğ‘—, ğ‘˜], . . . ]ï¼Œ
    # å¤–å±‚çš„æ‹¬å·é•¿åº¦ä¸ºé‡‡æ ·æ ·æœ¬çš„ä¸ªæ•°ï¼Œå†…å±‚åˆ—è¡¨åŒ…å«äº†æ¯ä¸ªé‡‡æ ·ç‚¹çš„ç´¢å¼•åæ ‡

    # æˆ‘ä»¬æŠ½å‡ºäº†ç­çº§ 1 çš„å­¦ç”Ÿ 1 çš„ç§‘ç›® 2ã€ç­çº§ 2 çš„å­¦ç”Ÿ 2 çš„ç§‘ç›® 3ã€
    # ç­çº§ 3 çš„å­¦ç”Ÿ 3 çš„ç§‘ç›® 4 çš„æˆç»©ï¼Œ
    # å…±æœ‰ 3 ä¸ªæˆç»©æ•°æ®ï¼Œç»“æœæ±‡æ€»ä¸ºä¸€ä¸ª shape ä¸º[3]çš„å¼ é‡
    # (3,)
    print(tf.gather_nd(x, [[0, 0, 1], [1, 1, 2], [2, 2, 3]]).shape)

    pass
